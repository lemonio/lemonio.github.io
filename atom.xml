<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lemon</title>
  
  <subtitle>不忘初心 方得始终</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-09-17T10:05:35.699Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Lemon</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2019/09/17/hello-world/"/>
    <id>http://yoursite.com/2019/09/17/hello-world/</id>
    <published>2019-09-17T10:05:35.699Z</published>
    <updated>2019-09-17T10:05:35.699Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>AM335x PROCESSOR-SDK-LINUX-AM335X  04_03_00_05移植记录</title>
    <link href="http://yoursite.com/2018/11/12/AM335x%20PROCESSOR-SDK-LINUX-AM335X%20%2004_03_00_05%E7%A7%BB%E6%A4%8D%E8%AE%B0%E5%BD%95/"/>
    <id>http://yoursite.com/2018/11/12/AM335x PROCESSOR-SDK-LINUX-AM335X  04_03_00_05移植记录/</id>
    <published>2018-11-11T17:14:30.000Z</published>
    <updated>2019-09-17T10:05:35.699Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>文中使用TI SDK 版本为<strong>PROCESSOR-SDK-LINUX-AM335X  04_03_00_05</strong>，SDK下载地址： <a href="http://software-dl.ti.com/processor-sdk-linux/esd/AM335X/04_03_00_05/index_FDS.html" target="_blank" rel="noopener">    ti-processor-sdk-linux-am335x-evm-04.03.00.05-Linux-x86-Install.bin</a></p><h2 id="AM335x启动过程"><a href="#AM335x启动过程" class="headerlink" title="AM335x启动过程"></a>AM335x启动过程</h2><h2 id="工程目录"><a href="#工程目录" class="headerlink" title="工程目录"></a>工程目录</h2><h2 id="编译指令"><a href="#编译指令" class="headerlink" title="编译指令"></a>编译指令</h2><h3 id="u-boot"><a href="#u-boot" class="headerlink" title="u-boot"></a>u-boot</h3><p><code>make CROSS_COMPILE=arm-linux-gnueabihf- O=am335x_evm am335x_evm_defconfig</code><br><code>make CROSS_COMPILE=arm-linux-gnueabihf- O=am335x_evm menuconfig</code><br><code>make CROSS_COMPILE=arm-linux-gnueabihf- O=am335x_evm</code><br><code>make CROSS_COMPILE=arm-linux-gnueabihf- distclean</code>  </p><h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><p><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- tisdk_am335x-evm_defconfig</code><br><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean</code><br><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- menuconfig</code><br><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage</code><br><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- am335x-evm.dtb</code><br><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules</code><br><code>make ARCH=arm INSTALL_MOD_PATH=/media/huiwei/rootfs modules_install</code>  </p><h3 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h3><p><code>mkfs.ubifs -F -q -r filesystem -m 2048 -e 126976 -c 2047 -o ubifs.img</code><br><code>ubinize -o ubi.img -m 2048 -p 128KiB ubinize.cfg</code></p><h2 id="U-Boot移植"><a href="#U-Boot移植" class="headerlink" title="U-Boot移植"></a>U-Boot移植</h2><h3 id="EEPROM处理"><a href="#EEPROM处理" class="headerlink" title="EEPROM处理"></a>EEPROM处理</h3><p>TI的am335x evm开发板使用了一个eeprom保存了板载配置信息，用来区分不同板卡的型号。如果板卡没有这个eeprom，需要修改U-Boot中eeprom的读取部分。否则会导致MLO无法启动，串口无任何信息输出。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改do_board_detect(board/ti/am335x/board.c)</span></span><br><span class="line"><span class="comment">// 关于板卡的检测是由CONFIG_TI_I2C_BOARD_DETECT宏来控制，位于board/ti/common/Kconfig。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TI_I2C_BOARD_DETECT</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_board_detect</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ti_i2c_eeprom_am_get_default(<span class="number">-1</span>, CONFIG_SYS_I2C_EEPROM_ADDR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加声明ti_i2c_eeprom_am_get_default(board/ti/common/board_detect.h)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ti_i2c_eeprom_am_get_default</span><span class="params">(<span class="keyword">int</span> bus_addr, <span class="keyword">int</span> dev_addr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加实现ti_i2c_eeprom_am_get_default(board/ti/common/board_detect.c)</span></span><br><span class="line"><span class="keyword">int</span> __<span class="function">maybe_unused <span class="title">ti_i2c_eeprom_am_get_default</span><span class="params">(<span class="keyword">int</span> bus_addr, <span class="keyword">int</span> dev_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ti_common_eeprom</span> *<span class="title">ep</span>;</span></span><br><span class="line"></span><br><span class="line">    ep = TI_EEPROM_DATA;</span><br><span class="line">    ep-&gt;header = <span class="number">0xEE3355AA</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(ep-&gt;name, <span class="string">"A335X_SK"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(ep-&gt;version, <span class="string">"1.2B"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(ep-&gt;serial, <span class="string">"45124P196447"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(ep-&gt;config, <span class="string">"SKU#00"</span>);</span><br><span class="line">    ep-&gt;mac_addr[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">0x11</span>;</span><br><span class="line">    ep-&gt;mac_addr[<span class="number">0</span>][<span class="number">1</span>]=<span class="number">0x22</span>;</span><br><span class="line">    ep-&gt;mac_addr[<span class="number">0</span>][<span class="number">2</span>]=<span class="number">0x33</span>;</span><br><span class="line">    ep-&gt;mac_addr[<span class="number">0</span>][<span class="number">3</span>]=<span class="number">0x44</span>;</span><br><span class="line">    ep-&gt;mac_addr[<span class="number">0</span>][<span class="number">4</span>]=<span class="number">0x55</span>;</span><br><span class="line">    ep-&gt;mac_addr[<span class="number">0</span>][<span class="number">5</span>]=<span class="number">0x66</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NAND配置"><a href="#NAND配置" class="headerlink" title="NAND配置"></a>NAND配置</h3><p>修改完eeprom之后，将MLO和uboot.img放入SD卡boot分区，设置SD卡启动模式，这时串口有了打印信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">U-Boot SPL 2017.01-00458-ga0c95a6-dirty (Dec 28 2018 - 23:46:03)</span><br><span class="line">Trying to boot from MMC1</span><br><span class="line">reading uboot.env</span><br><span class="line">reading u-boot.img</span><br><span class="line">reading u-boot.img</span><br><span class="line">reading u-boot.img</span><br><span class="line">reading u-boot.img</span><br><span class="line"></span><br><span class="line">U-Boot 2017.01-00458-ga0c95a6-dirty (Dec 28 2018 - 23:46:03 -0800)</span><br><span class="line"></span><br><span class="line">CPU  :  AM335X-GP rev 2.1</span><br><span class="line">Model:  TI AM335x EVM-SK</span><br><span class="line">DRAM:   256 MiB</span><br><span class="line">NAND:   0 MiB</span><br><span class="line">MMC:    OAMP SD/MMC: 0, OMAP SD/MMC: 1</span><br><span class="line">reading uboot.env</span><br><span class="line">Net:    Could not get PHY for cpsw: addr 0</span><br><span class="line">cpsw, usb_ether</span><br><span class="line">Hit any key to stop autoboot: 0</span><br></pre></td></tr></table></figure><p>从打印日志<strong>NAND:  0 MiB</strong>来看，uboot没有检测到Nand Flash。</p><p>当前的uboot版本已经引入了<strong>驱动模型DM（driver model）</strong>，DM为驱动的定义和访问接口提供了统一的方法，它依赖于uboot中的dts。关于NAND的DM配置选项为<strong>CONFIG_DM_NAND</strong>。查看<em>am335x_evm/.config<em>文件发现</em>CONFIG_DM_NAND=y</em>(该配置在configs/am335x_evm_defconfig中被设置)。我们可以把配置关掉或者修改uboot中的dts文件。</p><p>NAND的DM驱动在drivers/mtd/nand/omap_gpmc.c中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//drivers/mtd/nand/omap_gpmc.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">udevice_id</span> <span class="title">omap_gpmc_ids</span>[] = &#123;</span></span><br><span class="line">&#123; .compatible = <span class="string">"ti,am3352-gpmc"</span> &#125;,</span><br><span class="line">&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">U_BOOT_DRIVER(omap_gpmc) = &#123;</span><br><span class="line">.name= <span class="string">"omap_gpmc"</span>,</span><br><span class="line">.id= UCLASS_NAND,</span><br><span class="line">.of_match = omap_gpmc_ids,</span><br><span class="line">.ofdata_to_platdata = omap_gpmc_ofdata_to_platdata,</span><br><span class="line">.probe= omap_gpmc_probe,</span><br><span class="line">.priv_auto_alloc_size = <span class="keyword">sizeof</span>(struct nand_chip),</span><br><span class="line">.platdata_auto_alloc_size = <span class="keyword">sizeof</span>(struct omap_gpmc_platdata),</span><br><span class="line">.flags = DM_FLAG_ALLOC_PRIV_DMA,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>由于前面指定了板卡的类型<strong>A335X_SK</strong>，其对应的dts文件为<strong>am335x-evmsk.dts</strong></p><p>在am335x-evmsk.dts中添加nand配置</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//(arch/arm/dts/am335x-evmsk.dts)</span></span><br><span class="line"><span class="variable">&amp;elm</span> &#123;</span><br><span class="line">        status = <span class="string">"okay"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;gpmc</span> &#123;</span><br><span class="line">status = <span class="string">"okay"</span>;</span><br><span class="line">pinctrl-names = <span class="string">"default"</span>;</span><br><span class="line">pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;nandflash_pins_s0</span>&gt;</span>;</span><br><span class="line">ranges = <span class="params">&lt;<span class="number">0</span> <span class="number">0</span> <span class="number">0x08000000</span> <span class="number">0x1000000</span>&gt;</span>;<span class="comment">/* CS0: 16MB for NAND */</span></span><br><span class="line">nand@<span class="number">0</span>,<span class="number">0</span> &#123;</span><br><span class="line">compatible = <span class="string">"ti,omap2-nand"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0</span> <span class="number">0</span> <span class="number">4</span>&gt;</span>; <span class="comment">/* CS0, offset 0, IO size 4 */</span></span><br><span class="line">                interrupt-parent = <span class="params">&lt;<span class="variable">&amp;gpmc</span>&gt;</span>;</span><br><span class="line">                interrupts = <span class="params">&lt;<span class="number">0</span> IRQ_TYPE_NONE&gt;</span>, <span class="comment">/* fifoevent */</span></span><br><span class="line">                             <span class="params">&lt;<span class="number">1</span> IRQ_TYPE_NONE&gt;</span>; <span class="comment">/* termcount */</span></span><br><span class="line">                rb-gpios = <span class="params">&lt;<span class="variable">&amp;gpmc</span> <span class="number">0</span> GPIO_ACTIVE_HIGH&gt;</span>; <span class="comment">/* gpmc_wait0 */</span></span><br><span class="line">                ti,nand-xfer-type = <span class="string">"prefetch-dma"</span>;</span><br><span class="line">ti,nand-ecc-opt = <span class="string">"bch8"</span>;</span><br><span class="line">ti,elm-id = <span class="params">&lt;<span class="variable">&amp;elm</span>&gt;</span>;</span><br><span class="line">nand-bus-width = <span class="params">&lt;<span class="number">8</span>&gt;</span>;</span><br><span class="line">gpmc,device-width = <span class="params">&lt;<span class="number">1</span>&gt;</span>;</span><br><span class="line">gpmc,sync-clk-ps = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,cs-on-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,cs-rd-off-ns = <span class="params">&lt;<span class="number">44</span>&gt;</span>;</span><br><span class="line">gpmc,cs-wr-off-ns = <span class="params">&lt;<span class="number">44</span>&gt;</span>;</span><br><span class="line">gpmc,adv-on-ns = <span class="params">&lt;<span class="number">6</span>&gt;</span>;</span><br><span class="line">gpmc,adv-rd-off-ns = <span class="params">&lt;<span class="number">34</span>&gt;</span>;</span><br><span class="line">gpmc,adv-wr-off-ns = <span class="params">&lt;<span class="number">44</span>&gt;</span>;</span><br><span class="line">gpmc,we-on-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,we-off-ns = <span class="params">&lt;<span class="number">40</span>&gt;</span>;</span><br><span class="line">gpmc,oe-on-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,oe-off-ns = <span class="params">&lt;<span class="number">54</span>&gt;</span>;</span><br><span class="line">gpmc,access-ns = <span class="params">&lt;<span class="number">64</span>&gt;</span>;</span><br><span class="line">gpmc,rd-cycle-ns = <span class="params">&lt;<span class="number">82</span>&gt;</span>;</span><br><span class="line">gpmc,wr-cycle-ns = <span class="params">&lt;<span class="number">82</span>&gt;</span>;</span><br><span class="line">gpmc,wait-on-read = <span class="string">"true"</span>;</span><br><span class="line">gpmc,wait-on-write = <span class="string">"true"</span>;</span><br><span class="line">gpmc,bus-turnaround-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,cycle2cycle-delay-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,clk-activation-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,wait-monitoring-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line">gpmc,wr-access-ns = <span class="params">&lt;<span class="number">40</span>&gt;</span>;</span><br><span class="line">gpmc,wr-data-mux-bus-ns = <span class="params">&lt;<span class="number">0</span>&gt;</span>;</span><br><span class="line"><span class="comment">/* MTD partition table */</span></span><br><span class="line"><span class="comment">/* All SPL-* partitions are sized to minimal length</span></span><br><span class="line"><span class="comment"> * which can be independently programmable. For</span></span><br><span class="line"><span class="comment"> * NAND flash this is equal to size of erase-block */</span></span><br><span class="line"><span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line"><span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line"><span class="class">partition@0 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.SPL"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00000000</span> <span class="number">0x000020000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@1 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.SPL.backup1"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00020000</span> <span class="number">0x00020000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@2 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.SPL.backup2"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00040000</span> <span class="number">0x00020000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@3 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.SPL.backup3"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00060000</span> <span class="number">0x00020000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@4 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.u-boot-spl-os"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00080000</span> <span class="number">0x00040000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@5 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.u-boot"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x000C0000</span> <span class="number">0x00100000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@6 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.u-boot-env"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x001C0000</span> <span class="number">0x00020000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@7 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.u-boot-env.backup1"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x001E0000</span> <span class="number">0x00020000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@8 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.kernel"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00200000</span> <span class="number">0x00800000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class">partition@9 </span>&#123;</span><br><span class="line">label = <span class="string">"NAND.file-system"</span>;</span><br><span class="line">reg = <span class="params">&lt;<span class="number">0x00A00000</span> <span class="number">0x0F600000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//(arch/arm/dts/am335x-evmsk.dts)</span></span><br><span class="line"><span class="symbol">nandflash_pins_s0:</span> <span class="class">nandflash_pins_s0 </span>&#123;</span><br><span class="line">pinctrl-single,pins = <span class="params">&lt;</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x800</span>, PIN_INPUT_PULLUP | MUX_MODE0)      /* gpmc_ad0.gpmc_ad0 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x804</span>, PIN_INPUT_PULLUP | MUX_MODE0)      /* gpmc_ad1.gpmc_ad1 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x808</span>, PIN_INPUT_PULLUP | MUX_MODE0)      /* gpmc_ad2.gpmc_ad2 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x80c</span>, PIN_INPUT_PULLUP | MUX_MODE0)      /* gpmc_ad3.gpmc_ad3 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x810</span>, PIN_INPUT_PULLUP | MUX_MODE0)     /* gpmc_ad4.gpmc_ad4 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x814</span>, PIN_INPUT_PULLUP | MUX_MODE0)     /* gpmc_ad5.gpmc_ad5 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x818</span>, PIN_INPUT_PULLUP | MUX_MODE0)     /* gpmc_ad6.gpmc_ad6 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x81c</span>, PIN_INPUT_PULLUP | MUX_MODE0)     /* gpmc_ad7.gpmc_ad7 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x870</span>, PIN_INPUT_PULLUP | MUX_MODE0)     /* gpmc_wait0.gpmc_wait0 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x874</span>, PIN_INPUT_PULLUP | MUX_MODE7)     /* gpmc_wpn.gpio0_30 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x87c</span>, PIN_OUTPUT | MUX_MODE0)           /* gpmc_csn0.gpmc_csn0  */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x890</span>, PIN_OUTPUT | MUX_MODE0)           /* gpmc_advn_ale.gpmc_advn_ale */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x894</span>, PIN_OUTPUT | MUX_MODE0)           /* gpmc_oen_ren.gpmc_oen_ren */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x898</span>, PIN_OUTPUT | MUX_MODE0)           /* gpmc_wen.gpmc_wen */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x89c</span>, PIN_OUTPUT | MUX_MODE0)           /* gpmc_be0n_cle.gpmc_be0n_cle */</span></span><br><span class="line"><span class="params">    &gt;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>使能nand的pinmux</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//enable_board_pin_mux(board/ti/am335x/mux.c)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (board_is_evm_sk()) &#123;</span><br><span class="line"><span class="comment">/* Starter Kit EVM */</span></span><br><span class="line">    configure_module_pin_mux(nand_pin_mux);      <span class="comment">//添加NAND PINMUX配置</span></span><br><span class="line">    configure_module_pin_mux(i2c1_pin_mux);</span><br><span class="line">    configure_module_pin_mux(gpio0_7_pin_mux);</span><br><span class="line">    configure_module_pin_mux(rgmii1_pin_mux);</span><br><span class="line">    configure_module_pin_mux(mmc0_pin_mux_sk_evm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MMC配置"><a href="#MMC配置" class="headerlink" title="MMC配置"></a>MMC配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">mmc1_pins:</span> <span class="class">pinmux_mmc1_pins </span>&#123;</span><br><span class="line">pinctrl-single,pins = <span class="params">&lt;</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x8f0</span>, PIN_INPUT_PULLUP | MUX_MODE0) /* mmc0_dat3.mmc0_dat3, INPUT_PULLUP, MODE0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x8f4</span>, PIN_INPUT_PULLUP | MUX_MODE0) /* mmc0_dat2.mmc0_dat2, INPUT_PULLUP, MODE0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x8f8</span>, PIN_INPUT_PULLUP | MUX_MODE0) /* mmc0_dat1.mmc0_dat1, INPUT_PULLUP, MODE0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x8fc</span>, PIN_INPUT_PULLUP | MUX_MODE0) /* mmc0_dat0.mmc0_dat0, INPUT_PULLUP, MODE0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x900</span>, PIN_INPUT_PULLUP | MUX_MODE0) /* mmc0_clk.mmc0_clk, INPUT_PULLUP, MODE0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x904</span>, PIN_INPUT_PULLUP | MUX_MODE0) /* mmc0_cmd.mmc0_cmd, INPUT_PULLUP, MODE0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x9a0</span>, PIN_INPUT | MUX_MODE7) /* mcasp0_aclkr.gpio3_18 */</span></span><br><span class="line"><span class="params">&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;mmc1</span> &#123;</span><br><span class="line">        status = <span class="string">"okay"</span>;</span><br><span class="line">        vmmc-supply = <span class="params">&lt;<span class="variable">&amp;vmmc_reg</span>&gt;</span>;</span><br><span class="line">        bus-width = <span class="params">&lt;<span class="number">4</span>&gt;</span>;</span><br><span class="line">        pinctrl-names = <span class="string">"default"</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;mmc1_pins</span>&gt;</span>;</span><br><span class="line">        cd-gpios = <span class="params">&lt;<span class="variable">&amp;gpio3</span> <span class="number">18</span> GPIO_ACTIVE_LOW&gt;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ETH配置"><a href="#ETH配置" class="headerlink" title="ETH配置"></a>ETH配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">cpsw_default:</span> <span class="class">cpsw_default </span>&#123;</span><br><span class="line">pinctrl-single,pins = <span class="params">&lt;</span></span><br><span class="line"><span class="params">/* Slave <span class="number">1</span> */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x914</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mii1_txen.rgmii1_tctl */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x918</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)  /* mii1_rxdv.rgmii1_rctl */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x91c</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mii1_txd3.rgmii1_td3 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x920</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mii1_txd2.rgmii1_td2 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x924</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mii1_txd1.rgmii1_td1 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x928</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mii1_txd0.rgmii1_td0 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x92c</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mii1_txclk.rgmii1_tclk */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x930</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)  /* mii1_rxclk.rgmii1_rclk */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x934</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)  /* mii1_rxd3.rgmii1_rd3 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x938</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)  /* mii1_rxd2.rgmii1_rd2 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x93c</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)  /* mii1_rxd1.rgmii1_rd1 */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x940</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)  /* mii1_rxd0.rgmii1_rd0 */</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        /* Slave <span class="number">2</span> */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x840</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2)    /* gpmc_a0.rgmii2_tctl */</span></span><br><span class="line"><span class="params">        AM33XX_IOPAD(<span class="number">0x844</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)     /* gpmc_a1.rgmii2_rctl */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x848</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2)    /* gpmc_a2.rgmii2_td3 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x84c</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2)    /* gpmc_a3.rgmii2_td2 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x850</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2)    /* gpmc_a4.rgmii2_td1 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x854</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2)    /* gpmc_a5.rgmii2_td0 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x858</span>, PIN_OUTPUT_PULLDOWN | MUX_MODE2)    /* gpmc_a6.rgmii2_tclk */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x85c</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)     /* gpmc_a7.rgmii2_rclk */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x860</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)     /* gpmc_a8.rgmii2_rd3 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x864</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)     /* gpmc_a9.rgmii2_rd2 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x868</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)     /* gpmc_a10.rgmii2_rd1 */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x86c</span>, PIN_INPUT_PULLDOWN | MUX_MODE2)     /* gpmc_a11.rgmii2_rd0 */</span></span><br><span class="line"><span class="params">&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">cpsw_sleep:</span> <span class="class">cpsw_sleep </span>&#123;</span><br><span class="line">pinctrl-single,pins = <span class="params">&lt;</span></span><br><span class="line"><span class="params">/* Slave <span class="number">1</span> reset value */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x914</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x918</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x91c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x920</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x924</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x928</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x92c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x930</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x934</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x938</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x93c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x940</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">/* Slave <span class="number">2</span> reset value*/</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x840</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x844</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x848</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x84c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x850</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x854</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x858</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x85c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x860</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x864</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x868</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x86c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">davinci_mdio_default:</span> <span class="class">davinci_mdio_default </span>&#123;</span><br><span class="line">pinctrl-single,pins = <span class="params">&lt;</span></span><br><span class="line"><span class="params">/* MDIO */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x948</span>, PIN_INPUT_PULLUP | SLEWCTRL_FAST | MUX_MODE0)    /* mdio_data.mdio_data */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x94c</span>, PIN_OUTPUT_PULLUP | MUX_MODE0)                   /* mdio_clk.mdio_clk */</span></span><br><span class="line"><span class="params">&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">davinci_mdio_sleep:</span> <span class="class">davinci_mdio_sleep </span>&#123;</span><br><span class="line">pinctrl-single,pins = <span class="params">&lt;</span></span><br><span class="line"><span class="params">/* MDIO reset value */</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x948</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">AM33XX_IOPAD(<span class="number">0x94c</span>, PIN_INPUT_PULLDOWN | MUX_MODE7)</span></span><br><span class="line"><span class="params">&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;mac</span> &#123;</span><br><span class="line">        pinctrl-names = <span class="string">"default"</span>, <span class="string">"sleep"</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;cpsw_default</span>&gt;</span>;</span><br><span class="line">        pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;cpsw_sleep</span>&gt;</span>;</span><br><span class="line">        dual_emac = <span class="params">&lt;<span class="number">1</span>&gt;</span>;</span><br><span class="line">        status = <span class="string">"okay"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;davinci_mdio</span> &#123;</span><br><span class="line">        pinctrl-names = <span class="string">"default"</span>, <span class="string">"sleep"</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;davinci_mdio_default</span>&gt;</span>;</span><br><span class="line">        pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;davinci_mdio_sleep</span>&gt;</span>;</span><br><span class="line">        status = <span class="string">"okay"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;cpsw_emac0</span> &#123;</span><br><span class="line">        phy_id = <span class="params">&lt;<span class="variable">&amp;davinci_mdio</span>&gt;</span>, <span class="params">&lt;<span class="number">4</span>&gt;</span>;</span><br><span class="line">        phy-mode = <span class="string">"rgmii-txid"</span>;</span><br><span class="line">        dual_emac_res_vlan = <span class="params">&lt;<span class="number">1</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;cpsw_emac1</span> &#123;</span><br><span class="line">        phy_id = <span class="params">&lt;<span class="variable">&amp;davinci_mdio</span>&gt;</span>, <span class="params">&lt;<span class="number">6</span>&gt;</span>;</span><br><span class="line">        phy-mode = <span class="string">"rgmii-txid"</span>;</span><br><span class="line">        dual_emac_res_vlan = <span class="params">&lt;<span class="number">2</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="USB配置"><a href="#USB配置" class="headerlink" title="USB配置"></a>USB配置</h3><p>配置usb0和usb1工作在host模式</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;usb</span> &#123;</span><br><span class="line">status = <span class="string">"okay"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;usb_ctrl_mod</span> &#123;</span><br><span class="line">status = <span class="string">"okay"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;usb0</span> &#123;</span><br><span class="line">status = <span class="string">"okay"</span>;</span><br><span class="line">dr_mode = <span class="string">"host"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;usb1</span> &#123;</span><br><span class="line">status = <span class="string">"okay"</span>;</span><br><span class="line">dr_mode = <span class="string">"host"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NAND启动环境变量问题"><a href="#NAND启动环境变量问题" class="headerlink" title="NAND启动环境变量问题"></a>NAND启动环境变量问题</h3><p>15.nand启动环境变量问题：<br><strong>## Error: “bootcmd_nand0” not defined</strong><br>启动时会寻找环境变量<em>bootcmd_nand0<em>，但uboot生成的环境变量为</em>bootcmd_nand</em></p><p>修改 BOOTENV_DEV_NAND</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(include/configs/am335x_evm.h)</span><br><span class="line"><span class="comment">//#define BOOTENV_DEV_NAND(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="comment">//"bootcmd_" #devtypel "=" \</span></span><br><span class="line"><span class="comment">//"run nandboot\0"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTENV_DEV_NAND(devtypeu, devtypel, instance) \</span></span><br><span class="line"><span class="string">"bootcmd_"</span> <span class="meta">#devtypel #instance <span class="meta-string">"="</span> \</span></span><br><span class="line"><span class="string">"run nandboot\0"</span></span><br></pre></td></tr></table></figure><h3 id="支持U盘烧写Nand"><a href="#支持U盘烧写Nand" class="headerlink" title="支持U盘烧写Nand"></a>支持U盘烧写Nand</h3><p>从usb fat设备中加载文件</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//(cmd/fat.c)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">usb_fat_fsload</span> <span class="params">(<span class="keyword">char</span>*filename, <span class="keyword">char</span>* addr, <span class="keyword">int</span> *ReadSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *usbName = <span class="string">"usb"</span>;</span><br><span class="line">    <span class="keyword">long</span> size;</span><br><span class="line">    <span class="comment">//unsigned long offset;</span></span><br><span class="line">    <span class="keyword">char</span> *offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">blk_desc</span> *<span class="title">dev_desc</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">int</span> dev = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> part = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *ep;</span><br><span class="line"></span><br><span class="line">    dev = (<span class="keyword">int</span>)simple_strtoul (<span class="string">"0:4"</span>, &amp;ep, <span class="number">16</span>);</span><br><span class="line">    dev_desc = blk_get_dev(usbName, dev);</span><br><span class="line">    <span class="keyword">if</span> (dev_desc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span> (<span class="string">"\n** Invalid boot device **\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*ep) &#123;</span><br><span class="line">    <span class="keyword">if</span> (*ep != <span class="string">':'</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span> (<span class="string">"\n** Invalid boot device, use `dev[:part]' **\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">        part = (<span class="keyword">int</span>)simple_strtoul(++ep, <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">if</span> (fat_register_device(dev_desc, part)!=<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">"\n** Unable to use %s %d:%d for fatload **\n"</span>, usbName, dev, part);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">offset = addr;</span><br><span class="line"></span><br><span class="line">size = file_fat_read (filename, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *) offset, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(size == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n** Unable to read \"%s\" from %s %d:%d **\n"</span>, filename, usbName, dev, part);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span> (<span class="string">"\n%ld bytes read\n"</span>, size);</span><br><span class="line"><span class="keyword">if</span>(ReadSize)</span><br><span class="line">*ReadSize = size;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查找usb设备数量</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//(common/usb_storage.c)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">usb_stor_count</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (blk_first_device(IF_TYPE_USB, &amp;dev);</span><br><span class="line">dev;</span><br><span class="line">blk_next_device(&amp;dev)) &#123;</span><br><span class="line"><span class="comment">//struct blk_desc *desc = dev_get_uclass_platdata(dev);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//printf("  Device %d: ", desc-&gt;devnum);</span></span><br><span class="line"><span class="comment">//dev_print(desc);</span></span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (usb_max_devs &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; usb_max_devs; i++) &#123;</span><br><span class="line"><span class="comment">//printf("  Device %d: ", i);</span></span><br><span class="line"><span class="comment">//dev_print(&amp;usb_dev_desc[i]);</span></span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//return 0;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要的升级程序</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line">(common/autoboot.c)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+------------+--&gt;0x00000000-&gt; NAND.SPL start         (SPL copy on 1st block)</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x0001FFFF-&gt; NAND.SPL end </span></span><br><span class="line"><span class="comment">|            |--&gt;0x00020000-&gt; NAND.SPL.backup1 start (SPL copy on 2nd block)</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x0003FFFF-&gt; NAND.SPL.backup1 end </span></span><br><span class="line"><span class="comment">|            |--&gt;0x00040000-&gt; NAND.SPL.backup2 start (SPL copy on 3rd block)</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x0005FFFF-&gt; NAND.SPL.backup2 end </span></span><br><span class="line"><span class="comment">|            |--&gt;0x00060000-&gt; NAND.SPL.backup3 start (SPL copy on 4th block)</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x0007FFFF-&gt; NAND.SPL.backup3 end</span></span><br><span class="line"><span class="comment">|            |--&gt;0x00080000-&gt; NAND.u-boot-spl-os start</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x000BFFFF-&gt; NAND.u-boot-spl-os end</span></span><br><span class="line"><span class="comment">|            |--&gt;0x000C0000-&gt; NAND.u-boot start</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x001BFFFF-&gt; NAND.u-boot end</span></span><br><span class="line"><span class="comment">|            |--&gt;0x001C0000-&gt; NAND.u-boot-env start</span></span><br><span class="line"><span class="comment">|            |                                    </span></span><br><span class="line"><span class="comment">|            |--&gt;0x001DFFFF-&gt; NAND.u-boot-env end </span></span><br><span class="line"><span class="comment">|            |--&gt;0x001E0000-&gt; NAND.u-boot-env.backup1 start</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x001FFFFF-&gt; NAND.u-boot-env.backup1 end</span></span><br><span class="line"><span class="comment">|            |--&gt;0x00200000-&gt; NAND.kernel start</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |--&gt;0x009FFFFF-&gt; NAND.kernel end</span></span><br><span class="line"><span class="comment">|            |--&gt;0x00A00000-&gt; NAND.file-system start</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">|            |</span></span><br><span class="line"><span class="comment">+------------+--&gt;0x10000000-&gt; NAND end (Free end)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">device nand0 &lt;nand.0&gt;, # parts = 10</span></span><br><span class="line"><span class="comment"> #: namesizeoffsetmask_flags</span></span><br><span class="line"><span class="comment"> 0: NAND.SPL            0x000200000x000000000</span></span><br><span class="line"><span class="comment"> 1: NAND.SPL.backup1    0x000200000x000200000</span></span><br><span class="line"><span class="comment"> 2: NAND.SPL.backup2    0x000200000x000400000</span></span><br><span class="line"><span class="comment"> 3: NAND.SPL.backup3    0x000200000x000600000</span></span><br><span class="line"><span class="comment"> 4: NAND.u-boot-spl-os  0x000400000x000800000</span></span><br><span class="line"><span class="comment"> 5: NAND.u-boot         0x001000000x000c00000</span></span><br><span class="line"><span class="comment"> 6: NAND.u-boot-env     0x000200000x001c00000</span></span><br><span class="line"><span class="comment"> 7: NAND.u-boot-env.backup10x000200000x001e00000</span></span><br><span class="line"><span class="comment"> 8: NAND.kernel         0x008000000x002000000</span></span><br><span class="line"><span class="comment"> 9: NAND.file-system    0x0f6000000x00a000000</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_NUM(10)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_SPL0x00000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_SPL_BACKUP10x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_SPL_BACKUP20x00040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_SPL_BACKUP30x00060000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_UBOOT_SPL_OS0x00080000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_UBOOT0x000c0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_UBOOT_ENV0x001c0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_UBOOT_ENV_BACKUP10x001e0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_KERNEL0x00200000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFFSET_FILE_SYSTEM0x00a00000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_SPL0x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_SPL_BACKUP10x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_SPL_BACKUP20x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_SPL_BACKUP30x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_UBOOT_SPL_OS0x00040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_UBOOT0x00100000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_UBOOT_ENV0x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_UBOOT_ENV_BACKUP10x00020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_KERNEL0x00800000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_FILE_SYSTEM0x0f600000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SPL<span class="meta-string">"images/MLO"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SPL_BACKUP1<span class="meta-string">"images/MLO"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SPL_BACKUP2<span class="meta-string">"images/MLO"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SPL_BACKUP3<span class="meta-string">"images/MLO"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_UBOOT_SPL_OS<span class="meta-string">"images/am335x-evmsk.dtb"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_UBOOT<span class="meta-string">"images/u-boot.img"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_UBOOT_ENV<span class="meta-string">"images/uboot.env"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_UBOOT_ENV_BACKUP1<span class="meta-string">"images/uboot.env"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_KERNEL<span class="meta-string">"images/zImage"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_SYSTEM<span class="meta-string">"images/ubi.img"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_SPL<span class="meta-string">"NAND.SPL"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_SPL_BACKUP1<span class="meta-string">"NAND.SPL.backup1"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_SPL_BACKUP2<span class="meta-string">"NAND.SPL.backup2"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_SPL_BACKUP3<span class="meta-string">"NAND.SPL.backup3"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_UBOOT_SPL_OS<span class="meta-string">"NAND.u-boot-spl-os"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_UBOOT<span class="meta-string">"NAND.u-boot"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_UBOOT_ENV<span class="meta-string">"NAND.u-boot-env"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_UBOOT_ENV_BACKUP1<span class="meta-string">"NAND.u-boot-env.backup1"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_KERNEL<span class="meta-string">"NAND.kernel"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARTITION_FILE_SYSTEM<span class="meta-string">"NAND.file-system"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span>&#123;</span><br><span class="line">IMAGE_TYPE_RAW,</span><br><span class="line">IMAGE_TYPE_YAFFS2,</span><br><span class="line">IMAGE_TYPE_JFFS2,</span><br><span class="line">IMAGE_TYPE_UBIFS,</span><br><span class="line">IMAGE_TYPE_CRAMFS,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">usb_upload_nand</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Scanning USB..."</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ret = parse_string_outer(<span class="string">"usb start"</span>, FLAG_PARSE_SEMICOLON | FLAG_EXIT_FROM_LOOP);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"usb start failed\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get storage counter</span></span><br><span class="line"><span class="keyword">if</span>(usb_stor_count() == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"No USB Found. Booting...\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"USB Found.\n"</span>);</span><br><span class="line">udelay(<span class="number">2</span> * <span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Prepare to Updating...\n"</span>);</span><br><span class="line">udelay(<span class="number">2</span> * <span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *partition_name[PARTITION_NUM] = &#123; PARTITION_SPL, \</span><br><span class="line">PARTITION_SPL_BACKUP1, \</span><br><span class="line">PARTITION_SPL_BACKUP2, \</span><br><span class="line">PARTITION_SPL_BACKUP3, \</span><br><span class="line">PARTITION_UBOOT_SPL_OS, \</span><br><span class="line">PARTITION_UBOOT, \</span><br><span class="line">PARTITION_UBOOT_ENV, \</span><br><span class="line">PARTITION_UBOOT_ENV_BACKUP1, \</span><br><span class="line">PARTITION_KERNEL, \</span><br><span class="line">PARTITION_FILE_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *image_name[PARTITION_NUM] = &#123; IMAGE_SPL, \</span><br><span class="line">IMAGE_SPL_BACKUP1, \</span><br><span class="line">IMAGE_SPL_BACKUP2, \</span><br><span class="line">IMAGE_SPL_BACKUP3, \</span><br><span class="line">IMAGE_UBOOT_SPL_OS, \</span><br><span class="line">IMAGE_UBOOT, \</span><br><span class="line">IMAGE_UBOOT_ENV, \</span><br><span class="line">IMAGE_UBOOT_ENV_BACKUP1, \</span><br><span class="line">IMAGE_KERNEL, \</span><br><span class="line">IMAGE_FILE_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> partition_addr[PARTITION_NUM] = &#123;OFFSET_SPL, \</span><br><span class="line">OFFSET_SPL_BACKUP1, \</span><br><span class="line">OFFSET_SPL_BACKUP2, \</span><br><span class="line">OFFSET_SPL_BACKUP3, \</span><br><span class="line">OFFSET_UBOOT_SPL_OS, \</span><br><span class="line">OFFSET_UBOOT, \</span><br><span class="line">OFFSET_UBOOT_ENV, \</span><br><span class="line">OFFSET_UBOOT_ENV_BACKUP1, \</span><br><span class="line">OFFSET_KERNEL, \</span><br><span class="line">OFFSET_FILE_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> load_addr[PARTITION_NUM] = &#123;<span class="number">0x82000000</span> + OFFSET_SPL, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_SPL_BACKUP1, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_SPL_BACKUP2, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_SPL_BACKUP3, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_UBOOT_SPL_OS, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_UBOOT, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_UBOOT_ENV, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_UBOOT_ENV_BACKUP1, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_KERNEL, \</span><br><span class="line"><span class="number">0x82000000</span> + OFFSET_FILE_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> partition_size[PARTITION_NUM] = &#123;SIZE_SPL, \</span><br><span class="line">SIZE_SPL_BACKUP1, \</span><br><span class="line">SIZE_SPL_BACKUP2, \</span><br><span class="line">SIZE_SPL_BACKUP3, \</span><br><span class="line">SIZE_UBOOT_SPL_OS, \</span><br><span class="line">SIZE_UBOOT, \</span><br><span class="line">SIZE_UBOOT_ENV, \</span><br><span class="line">SIZE_UBOOT_ENV_BACKUP1, \</span><br><span class="line">SIZE_KERNEL, \</span><br><span class="line">SIZE_FILE_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> image_size[PARTITION_NUM] = &#123;SIZE_SPL, \</span><br><span class="line">SIZE_SPL_BACKUP1, \</span><br><span class="line">SIZE_SPL_BACKUP2, \</span><br><span class="line">SIZE_SPL_BACKUP3, \</span><br><span class="line">SIZE_UBOOT_SPL_OS, \</span><br><span class="line">SIZE_UBOOT, \</span><br><span class="line">SIZE_UBOOT_ENV, \</span><br><span class="line">SIZE_UBOOT_ENV_BACKUP1, \</span><br><span class="line">SIZE_KERNEL, \</span><br><span class="line">SIZE_FILE_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> image_type[PARTITION_NUM] = &#123;IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW, \</span><br><span class="line">IMAGE_TYPE_RAW&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buffer[<span class="number">128</span>];</span><br><span class="line">buffer[<span class="number">127</span>] = <span class="string">'\0'</span>;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; PARTITION_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Checking %s \n"</span>, image_name[i]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> step[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(step, <span class="string">"[%d/%d]"</span>, i+<span class="number">1</span>, PARTITION_NUM);</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(buffer, <span class="string">"Step:%s Checking %s...\n"</span>, step, image_name[i]);</span><br><span class="line"><span class="built_in">printf</span>(buffer);</span><br><span class="line">ret = usb_fat_fsload(image_name[i], load_addr[i], &amp;image_size[i]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">0</span> &amp;&amp; image_size[i] &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">sprintf</span>(<span class="string">"%s%s is lost."</span>, step, partition_name[i]);</span><br><span class="line"><span class="built_in">printf</span>(buffer);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"load image failed!!!\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(buffer, <span class="string">"%s Success."</span>, step);</span><br><span class="line">udelay(<span class="number">2</span> * <span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[DO NOT POWER OFF]\n"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Load success !!! </span></span><br><span class="line">    <span class="comment">// Start write nand</span></span><br><span class="line"><span class="keyword">char</span> cmd[<span class="number">255</span>];</span><br><span class="line"><span class="keyword">char</span> *command = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; PARTITION_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span>(image_type[i])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> IMAGE_TYPE_RAW:</span><br><span class="line">command = <span class="string">"nand write "</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> IMAGE_TYPE_YAFFS2:</span><br><span class="line">command = <span class="string">"nand write.yaffs2 "</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> IMAGE_TYPE_JFFS2:</span><br><span class="line">command = <span class="string">" "</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> IMAGE_TYPE_UBIFS:</span><br><span class="line">command = <span class="string">"ubi write "</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(buffer, <span class="string">"[%d/%d]Updating %s...\n"</span>, i+<span class="number">1</span>, PARTITION_NUM, partition_name[i]);</span><br><span class="line"><span class="built_in">printf</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(cmd, <span class="string">"nand erase %x  %x ; %s %x %x %x ;"</span>, partition_addr[i], partition_size[i], command, load_addr[i], partition_addr[i], image_size[i]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"cmd : %s \n"</span>, cmd);</span><br><span class="line"></span><br><span class="line">ret = parse_string_outer(cmd, FLAG_PARSE_SEMICOLON | FLAG_EXIT_FROM_LOOP);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//write  error</span></span><br><span class="line"><span class="built_in">sprintf</span>(ivp2_check_err_msg, <span class="string">"[%d/%d]Partition %s corrupt"</span>, i, PARTITION_NUM, partition_name[i]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(buffer, <span class="string">"[%d/%d] Success.\n"</span>, i+<span class="number">1</span>, PARTITION_NUM);</span><br><span class="line"><span class="built_in">printf</span>(buffer);</span><br><span class="line">udelay(<span class="number">2</span> * <span class="number">1000</span> * <span class="number">1000</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[SUCCESS]\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>倒数之后，检测USB，执行升级程序</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">autoboot_command</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">debug(<span class="string">"### main_loop: bootcmd=\"%s\"\n"</span>, s ? s : <span class="string">"&lt;UNDEFINED&gt;"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (stored_bootdelay != <span class="number">-1</span> &amp;&amp; s &amp;&amp; !abortboot(stored_bootdelay)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(usb_upload_nand() != <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"usb_upload_nand failed!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"usb_upload_nand success!\n"</span>);</span><br><span class="line">udelay(<span class="number">2</span> * <span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"enter kernel!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_AUTOBOOT_KEYED) &amp;&amp; !defined(CONFIG_AUTOBOOT_KEYED_CTRLC)</span></span><br><span class="line"><span class="keyword">int</span> prev = disable_ctrlc(<span class="number">1</span>);<span class="comment">/* disable Control C checking */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_AUTOBOOT_KEYED) &amp;&amp; !defined(CONFIG_AUTOBOOT_KEYED_CTRLC)</span></span><br><span class="line">disable_ctrlc(prev);<span class="comment">/* restore Control C checking */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MENUKEY</span></span><br><span class="line"><span class="keyword">if</span> (menukey == CONFIG_MENUKEY) &#123;</span><br><span class="line">s = getenv(<span class="string">"menucmd"</span>);</span><br><span class="line"><span class="keyword">if</span> (s)</span><br><span class="line">run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_MENUKEY */</span></span></span><br></pre></td></tr></table></figure><h3 id="Nand-Flash分区"><a href="#Nand-Flash分区" class="headerlink" title="Nand Flash分区"></a>Nand Flash分区</h3><blockquote><p>|····························|–&gt;0x00000000-&gt; NAND.SPL start         (SPL copy on 1st block)<br>|····························|<br>|····························|–&gt;0x0001FFFF-&gt; NAND.SPL end<br>|····························|–&gt;0x00020000-&gt; NAND.SPL.backup1 start (SPL copy on 2nd block)<br>|····························|<br>|····························|–&gt;0x0003FFFF-&gt; NAND.SPL.backup1 end<br>|····························|–&gt;0x00040000-&gt; NAND.SPL.backup2 start (SPL copy on 3rd block)<br>|····························|<br>|····························|–&gt;0x0005FFFF-&gt; NAND.SPL.backup2 end<br>|····························|–&gt;0x00060000-&gt; NAND.SPL.backup3 start (SPL copy on 4th block)<br>|····························|<br>|····························|–&gt;0x0007FFFF-&gt; NAND.SPL.backup3 end<br>|····························|–&gt;0x00080000-&gt; NAND.u-boot-spl-os start<br>|····························|<br>|····························|–&gt;0x000BFFFF-&gt; NAND.u-boot-spl-os end<br>|····························|–&gt;0x000C0000-&gt; NAND.u-boot start<br>|····························|<br>|····························|–&gt;0x001BFFFF-&gt; NAND.u-boot end<br>|····························|–&gt;0x001C0000-&gt; NAND.u-boot-env start<br>|····························|<br>|····························|–&gt;0x001DFFFF-&gt; NAND.u-boot-env end<br>|····························|–&gt;0x001E0000-&gt; NAND.u-boot-env.backup1 start<br>|····························|<br>|····························|–&gt;0x001FFFFF-&gt; NAND.u-boot-env.backup1 end<br>|····························|–&gt;0x00200000-&gt; NAND.kernel start<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|–&gt;0x009FFFFF-&gt; NAND.kernel end<br>|····························|–&gt;0x00A00000-&gt; NAND.file-system start<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|<br>|····························|–&gt;0x10000000-&gt; NAND end (Free end)  </p><table><thead><tr><th align="center">Name</th><th align="center">Size</th><th align="center">offset</th><th align="center">mask_flags</th></tr></thead><tbody><tr><td align="center">0: NAND.SPL</td><td align="center">0x00020000</td><td align="center">0x00000000</td><td align="center">0</td></tr><tr><td align="center">1: NAND.SPL.backup1</td><td align="center">0x00020000</td><td align="center">0x00020000</td><td align="center">0</td></tr><tr><td align="center">2: NAND.SPL.backup2</td><td align="center">0x00020000</td><td align="center">0x00040000</td><td align="center">0</td></tr><tr><td align="center">3: NAND.SPL.backup3</td><td align="center">0x00020000</td><td align="center">0x00060000</td><td align="center">0</td></tr><tr><td align="center">4: NAND.u-boot-spl-os</td><td align="center">0x00040000</td><td align="center">0x00080000</td><td align="center">0</td></tr><tr><td align="center">5: NAND.u-boot</td><td align="center">0x00100000</td><td align="center">0x000c0000</td><td align="center">0</td></tr><tr><td align="center">6: NAND.u-boot-env</td><td align="center">0x00020000</td><td align="center">0x001c0000</td><td align="center">0</td></tr><tr><td align="center">7: NAND.u-boot-env.backup1</td><td align="center">0x00020000</td><td align="center">0x001e0000</td><td align="center">0</td></tr><tr><td align="center">8: NAND.kernel</td><td align="center">0x00800000</td><td align="center">0x00200000</td><td align="center">0</td></tr><tr><td align="center">9: NAND.file-system</td><td align="center">0x0f600000</td><td align="center">0x00a00000</td><td align="center">0</td></tr></tbody></table></blockquote><h2 id="Kernel移植"><a href="#Kernel移植" class="headerlink" title="Kernel移植"></a>Kernel移植</h2><h3 id="添加SCSI-SG驱动"><a href="#添加SCSI-SG驱动" class="headerlink" title="添加SCSI SG驱动"></a>添加SCSI SG驱动</h3><blockquote><p>Device Drivers  —&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;SCSI device support  —&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCSI generic support     [Symbol: CHR_DEV_SG]                                                                                                                                       </p></blockquote><h3 id="添加CP210x-USB-Serial-Converter驱动"><a href="#添加CP210x-USB-Serial-Converter驱动" class="headerlink" title="添加CP210x USB Serial Converter驱动"></a>添加CP210x USB Serial Converter驱动</h3><blockquote><p>Device Drivers  —&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;USB support  —&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;USB Serial Converter support  —&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;USB CP210x family of UART Bridge Controllers</p></blockquote><h3 id="dts配置"><a href="#dts配置" class="headerlink" title="dts配置"></a>dts配置</h3><p>Kernel dts路径 arch/arm/boot/dts/am335x-evmsk.dts<br>配置方法与u-boot类似</p><h2 id="Rootfs移植"><a href="#Rootfs移植" class="headerlink" title="Rootfs移植"></a>Rootfs移植</h2><p>进入内核目录执行以下命令安装模块，INSTALL_MOD_PATH为文件系统目录，内核配置有更新时安装。</p><blockquote><p>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules<br>make ARCH=arm INSTALL_MOD_PATH=/media/huiwei/rootfs modules_install</p></blockquote><p>将ti-processor-sdk-linux-am335x-evm-04.03.00.05/filesystem/lib/firmware/目录中的文件拷贝到文件系统/lib/firmware</p><p>进入文件系统的上级目录，执行以下命令</p><blockquote><p>mkfs.ubifs -F -q -r filesystem -m 2048 -e 126976 -c 2047 -o ubifs.img<br>ubinize -o ubi.img -m 2048 -p 128KiB ubinize.cfg</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ubinize.cfg文件内容</span></span><br><span class="line">[ubifs]</span><br><span class="line">mode=ubi</span><br><span class="line">image=ubifs.img</span><br><span class="line">vol_id=<span class="number">0</span></span><br><span class="line">vol_size=<span class="number">200</span>MiB</span><br><span class="line">vol_type=dynamic</span><br><span class="line">vol_name=rootfs</span><br><span class="line">vol_flags=autoresize</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：</strong></p><ul><li>mkfs.ubifs 和 ubinize 最好使用SDK中的二进制文件，目录为ti-processor-sdk-linux-am335x-evm-04.03.00.05/linux-devkit/sysroots/x86_64-arago-linux/usr/bin/</li><li>ubifs.img为ubi格式镜像，在Nand烧写时使用ubi write命令烧写</li><li>ubi.img为处理之后的raw格式镜像，在Nand烧写时使用nand write命令烧写</li><li>filesystem 为rootfs目录的路径</li></ul></blockquote><h2 id="Nand-Flash烧写"><a href="#Nand-Flash烧写" class="headerlink" title="Nand Flash烧写"></a>Nand Flash烧写</h2><h3 id="MMC烧写Nand-Flash"><a href="#MMC烧写Nand-Flash" class="headerlink" title="MMC烧写Nand Flash"></a>MMC烧写Nand Flash</h3><p><code>mmc rescan</code><br><code>nand erase 0x0 0xA00000</code><br><code>fatload mmc 0 0x82000000 MLO</code><br><code>cp.b 0x82000000 0x82020000 20000</code><br><code>cp.b 0x82000000 0x82040000 20000</code><br><code>cp.b 0x82000000 0x82060000 20000</code><br><code>fatload mmc 0 0x82080000 am335x-evmsk.dtb</code><br><code>fatload mmc 0 0x820C0000 u-boot.img</code><br><code>fatload mmc 0 0x82200000 zImage</code><br><code>nand write 0x82000000 0x0 0xA00000</code>  </p><p><code>fatload mmc 0 0x82000000 ubi.img</code><br><code>nand erase 0xA00000 0xF600000</code><br><code>nand write 0x82000000 0xA00000 0x1860000</code>  </p><h3 id="USB烧写Nand-Flash"><a href="#USB烧写Nand-Flash" class="headerlink" title="USB烧写Nand Flash"></a>USB烧写Nand Flash</h3><p><code>usb start</code><br><code>nand erase 0x0 0xA00000</code><br><code>fatload usb 0:4 0x82000000 MLO</code><br><code>cp.b 0x82000000 0x82020000 20000</code><br><code>cp.b 0x82000000 0x82040000 20000</code><br><code>cp.b 0x82000000 0x82060000 20000</code><br><code>fatload usb 0:4 0x82080000 am335x-evmsk.dtb</code><br><code>fatload usb 0:4 0x820C0000 u-boot.img</code><br><code>fatload usb 0:4 0x82200000 zImage</code><br><code>nand write 0x82000000 0x0 0xA00000</code>  </p><p><code>fatload usb 0:4 0x82000000 ubi.img</code><br><code>nand erase 0xA00000 0xF600000</code><br><code>nand write 0x82000000 0xA00000 0x1860000</code></p><h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a href="http://software-dl.ti.com/processor-sdk-linux/esd/docs/04_03_00_05/linux/Foundational_Components.html#processor-sdk-linux-u-boot" target="_blank" rel="noopener"> Processor SDK Linux 04_03_00_05 Foundational Components U-Boot </a><br><a href="http://processors.wiki.ti.com/index.php/AM335x_U-Boot_User%27s_Guide" target="_blank" rel="noopener">AM335x U-Boot User’s Guide</a><br><a href="http://processors.wiki.ti.com/images/4/4f/Am335x_iamotorctrlevm_zczbaseboard_3H0007_schematic_rev1_2A.pdf" target="_blank" rel="noopener">ARM MPU AM335X Industrial Automation EVM Base Board</a><br><a href="http://www.ti.com/lit/ug/spruh73p/spruh73p.pdf" target="_blank" rel="noopener">AM335x and AMIC110 Sitara™ Processors Technical Reference Manual (Rev. P)</a><br><a href="http://www.ti.com/lit/ds/symlink/am3358.pdf" target="_blank" rel="noopener">AM335x DataSheet</a><br><a href="https://blog.csdn.net/XY_2206/article/details/78444317" target="_blank" rel="noopener">AM335x 硬件接口内存映射地址查询</a>  </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="AM335X" scheme="http://yoursite.com/categories/AM335X/"/>
    
    
      <category term="AM335X" scheme="http://yoursite.com/tags/AM335X/"/>
    
  </entry>
  
  <entry>
    <title>常用网站</title>
    <link href="http://yoursite.com/2018/11/07/%E5%B8%B8%E7%94%A8%E7%BD%91%E7%AB%99/"/>
    <id>http://yoursite.com/2018/11/07/常用网站/</id>
    <published>2018-11-06T17:14:30.000Z</published>
    <updated>2019-09-17T10:05:35.698Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><ol><li>Linux Source Code: <a href="https://elixir.bootlin.com/linux/latest/source" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/latest/source</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
